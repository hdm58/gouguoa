{extend name="../../base/view/common/base" /}
{block name="style"}
<link rel="stylesheet" href="{__LAYUI__}/plugin/dtree/dtree.css">
<link rel="stylesheet" href="{__LAYUI__}/plugin/dtree/font/dtreefont.css">
<style>
.layui-table-min th{font-size:13px; text-align:center; background-color:#f8f8f8;}
.layui-table-min td{font-size:13px; padding:6px;text-align:center;}
.layui-form-radio{margin-right:6px}
.layui-form-radio>i{margin-right:3px; }
</style>
{/block}
<!-- 主体 -->
{block name="body"}
<form class="layui-form page-content">
	<h3 class="h3-title">申请开票</h3>
	{if condition="($id == 0)"}
	<table class="layui-table">
		<tr>
			<td class="layui-td-gray">开票金额<span style="color: red">*</span></td>
			<td>
				<input type="text" class="layui-input" name="amount" lay-verify="required|number" placeholder="请输入开票金额" lay-reqText="请输入开票金额" value="">	
			</td>
			<td class="layui-td-gray">开票类型<span style="color: red">*</span></td>
			<td>
			<select name="invoice_type" lay-verify="required" lay-reqText="请选择开票类型">
				<option value="">请选择开票类型</option>
				<option value="1">增值税专用发票</option>
				<option value="2">增值税普通发票</option>
			  </select>
			</td>
			<td class="layui-td-gray">开票主体<span style="color: red">*</span></td>
			<td>
				<select name="invoice_subject" lay-verify="required" lay-reqText="请选择开票主体">
					<option value="">请选择开票主体</option>
					{volist name=":finance_invoice_subject()" id="vo"}
					<option value="{$vo.id}">{$vo.title}</option>
					{/volist}
				</select>
			</td>
		</tr>
		<tr>
			<td class="layui-td-gray">抬头类型<span style="color: red">*</span></td>
			<td>
				<input type="radio" name="type" lay-filter="type" value="1" title="企业" checked>
				<input type="radio" name="type" lay-filter="type" value="2" title="个人">
			</td>
			<td class="layui-td-gray">开票抬头<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_title" class="layui-input" value="" lay-verify="required"  lay-reqText="请输入开票抬头"></td>
			<td class="layui-td-gray">电话号码<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_phone" class="layui-input" value="" lay-verify="required"  lay-reqText="请输入电话号码"></td>
		</tr>
		<tr class="invoice-type">
			<td class="layui-td-gray2">纳税人识别号<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_tax" class="layui-input" value=""></td>
			<td class="layui-td-gray">开户行<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_bank" class="layui-input" value=""></td>
			<td class="layui-td-gray">银行账号<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_account" class="layui-input" value=""></td>
		</tr>
		<tr class="invoice-type">
			<td class="layui-td-gray2">银行营业网点<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_banking" class="layui-input" value=""></td>
			<td class="layui-td-gray">地址<span style="color: red">*</span></td>
			<td colspan="3"><input type="text" name="invoice_address" class="layui-input" value=""></td>
		</tr>
		<tr>
			<td class="layui-td-gray">备注信息</td>
			<td colspan="5"><textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea></td>
		</tr>
		<tr>
			<td class="layui-td-gray">审批流程<font>*</font></td>
			<td colspan="5">
				<select name="flow_id" lay-verify="required" lay-filter="flowtype" lay-reqText="请选择审批流程">
				<option value="">--请选择--</option>
				{volist name="flows" id="vo"}
				  <option value="{$vo.id}" title="{$vo.check_type}">{$vo.name}</option>
				{/volist}
				</select>
			</td>
		</tr>
		<tr id="flow_tr">
			<td class="layui-td-gray">审核人<font>*</font></td>
			<td colspan="5">
				<input type="hidden" name="check_admin_ids" value="" readonly><input type="text" name="check_admin_name" value="" autocomplete="off" placeholder="请选择审核人" lay-verify="required" lay-reqText="请选择审核人" class="layui-input" readonly>
			</td>
		</tr>
	</table>
	{else/}
		<table class="layui-table">
		<tr>
			<td class="layui-td-gray">开票金额<span style="color: red">*</span></td>
			<td>
				<input type="text" class="layui-input" name="amount" lay-verify="required|number" placeholder="请输入开票金额" lay-reqText="请输入开票金额" value="{$detail.amount}">	
			</td>
			<td class="layui-td-gray">开票类型<span style="color: red">*</span></td>
			<td>
			<select name="invoice_type" lay-verify="required" lay-reqText="请选择开票类型">
				<option value="">请选择开票类型</option>
				<option value="1" {eq name="$detail.invoice_type" value="1"}selected{/eq}>增值税专用发票</option>
				<option value="2" {eq name="$detail.invoice_type" value="2"}selected{/eq}>增值税普通发票</option>
			  </select>
			</td>
			<td class="layui-td-gray">开票主体<span style="color: red">*</span></td>
			<td>
				<select name="invoice_subject" lay-verify="required" lay-reqText="请选择开票主体">
					<option value="">请选择开票主体</option>
					{volist name=":finance_invoice_subject()" id="vo"}
					<option value="{$vo.id}" {eq name="$vo.id" value="$detail.invoice_subject"}selected{/eq}>{$vo.title}</option>
					{/volist}
				</select>
			</td>
		</tr>
		<tr>
			<td class="layui-td-gray">抬头类型<span style="color: red">*</span></td>
			<td>
				<input type="radio" name="type" lay-filter="type" value="1" title="企业" {eq name="$detail.type" value="1"}checked{/eq}>
				<input type="radio" name="type" lay-filter="type" value="2" title="个人" {eq name="$detail.type" value="2"}checked{/eq}>
			</td>
			<td class="layui-td-gray">开票抬头<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_title" class="layui-input" value="{$detail.invoice_title}"></td>
			<td class="layui-td-gray">电话号码<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_phone" class="layui-input" value="{$detail.invoice_phone}"></td>
		</tr>
		<tr class="invoice-type" {eq name="$detail.type" value="2"}style="display:none"{/eq}>
			<td class="layui-td-gray2">纳税人识别号<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_tax" class="layui-input" value="{$detail.invoice_tax}"></td>
			<td class="layui-td-gray">开户行<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_bank" class="layui-input" value="{$detail.invoice_bank}"></td>
			<td class="layui-td-gray">银行账号<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_account" class="layui-input" value="{$detail.invoice_account}"></td>
		</tr>
		<tr class="invoice-type" {eq name="$detail.type" value="2"}style="display:none"{/eq}>
			<td class="layui-td-gray2">银行营业网点<span style="color: red">*</span></td>
			<td><input type="text" name="invoice_banking" class="layui-input" value="{$detail.invoice_banking}"></td>
			<td class="layui-td-gray">地址<span style="color: red">*</span></td>
			<td colspan="3"><input type="text" name="invoice_address" class="layui-input" value="{$detail.invoice_address}"></td>
		</tr>
		<tr>
			<td class="layui-td-gray">备注信息</td>
			<td colspan="5"><textarea name="remark" placeholder="请输入备注信息" class="layui-textarea">{$detail.remark}</textarea></td>
		</tr>
		<tr>
			<td class="layui-td-gray">审批流程<font>*</font></td>
			<td colspan="5">
				<select name="flow_id" lay-verify="required" lay-filter="flowtype" lay-reqText="请选择审批流程">
				<option value="">--请选择--</option>
				{volist name="flows" id="vo"}
				  <option value="{$vo.id}" title="{$vo.check_type}">{$vo.name}</option>
				{/volist}
				</select>
			</td>
		</tr>
		<tr id="flow_tr">
			<td class="layui-td-gray">审核人<font>*</font></td>
			<td colspan="5">
				<input type="hidden" name="check_admin_ids" value="" readonly><input type="text" name="check_admin_name" value="" autocomplete="off" placeholder="请选择审核人" lay-verify="required" lay-reqText="请选择审核人" class="layui-input" readonly>
			</td>
		</tr>
	</table>
	{/if}

	<div class="layui-form-item" style="padding-top:10px;">
		<input name="id" id="id" type="hidden" value="{$id}">
		<button class="layui-btn" lay-submit="" lay-filter="webform">保存并提交审核</button>
		<button type="reset" class="layui-btn layui-btn-primary">重置</button>
	</div>
</form>
{/block}
<!-- /主体 -->

<!-- 脚本 -->
{block name="script"}
	<script>
	function init(layui){
		var form = layui.form
		  ,layer = layui.layer
		  ,employeepicker = layui.employeepicker
		  ,laydate = layui.laydate;

		//选择收件人类型
		form.on('radio(type)', function (data) {
			if(data.value==2){
				$('.invoice-type').hide();
			}
			else{
				$('.invoice-type').show();
			}
		});	
		
//选择人员		
		$('.layui-form').on('click','[name="check_admin_name"]',function(){
			if($('[name="flow_id"]').val()==''){
				layer.msg('请先选择审批流程');
				return false;
			}
			employeepicker.init({
				department_url: "/api/index/get_department_tree",
				employee_url: "/api/index/get_employee",
				type:0,
				callback:function(ids,names){
					$('[name="check_admin_ids"]').val(ids),
					$('[name="check_admin_name"]').val(names);
				}
			});
		})
		
		form.on('select(flowtype)', function(data){
			var check_type = data.elem[data.elem.selectedIndex].title;
			var formHtml='<td class="layui-td-gray">审核人<font>*</font></td>\
			<td colspan="5">\
				<input type="hidden" name="check_admin_ids" value="" readonly><input type="text" name="check_admin_name" value="" autocomplete="off" placeholder="请选择审核人" lay-verify="required" lay-reqText="请选择审核人" class="layui-input" readonly>\
			</td>';
			if(check_type == 2){
				$('#flow_tr').html(formHtml);
				form.render();
			}
			else{
				$.ajax({
					url: "/api/index/get_flow_users",
					type:'post',
					data:{id:data.value},
					success: function (e) {
						if (e.code == 0) {
							var flowLi='';
							for(var a=0;a<e.data.length;a++){
								var userList='',sign_type = '';
								if(e.data[a].flow_type==1){
									userList+= '<li style="padding:3px 0">当前部门负责人</li>';
								}
								else if(e.data[a].flow_type==2){
									userList+= '<li style="padding:3px 0">上级部门负责人</li>';
								}
								else{
									if(e.data[a].flow_type==3){
										sign_type= ' <span class="layui-badge layui-bg-blue">或签</span>'
									}
									if(e.data[a].flow_type==4){
										sign_type= ' <span class="layui-badge layui-bg-blue">会签</span>'
									}
									for(var b=0;b<e.data[a].user_id_info.length;b++){
										userList+= '<li style="padding:3px 0"><img src="'+e.data[a].user_id_info[b].thumb+'" style="width:24px; height:24px; border-radius:50%; margin-right:8px;" />'+e.data[a].user_id_info[b].name+'</li>';
									}
								}
								flowLi+='<li class="layui-timeline-item">\
									<i class="layui-icon layui-timeline-axis">&#xe63f;</i>\
									<div class="layui-timeline-content">\
									  <p class="layui-timeline-title"><strong>第'+(a+1)+'级审批</strong>'+sign_type+'</p>\
									  <ul>'+userList+'</ul>\
									</div>\
								</li>';
							}
							
							formHtml = '<td class="layui-td-gray">审批流程</td>\
										<td colspan="5">\
											<ul id="flowList" class="layui-timeline">'+flowLi+'</ul>\
										</td>';
							$('#flow_tr').html(formHtml);
						}
					}
				})
			}

		});	
		
		
		//监听提交
		form.on('submit(webform)', function(data){		  	
			$.ajax({
				url: "/finance/invoice/add",
				type:'post',
				data:data.field,
				success:function(e){
					layer.msg(e.msg);
					if (e.code == 0) {
						parent.tableIns.reload();
						setTimeout(function(){
							parent.layui.rightpage.close();
						},1000);
					}
				}
			})
			return false;
		});
	}
		
	</script>
{include file="../../base/view/common/layui" base='base' extend="['employeepicker']" callback="init" /}
{/block}
<!-- /脚本 -->